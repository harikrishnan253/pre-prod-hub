<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S4carlisle Reference Tools - {% block title %}{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {% block extra_css %}{% endblock %}
</head>

<body class="rainbow-bg">
    <div class="bubbles"></div>

    {% if not request.endpoint in ['login', 'register'] %}
    <header class="app-header">
        <div class="header-container container">
            <a href="{% if session.get('is_admin') %}{{ url_for('admin.admin_dashboard') }}{% else %}{{ url_for('main.dashboard') }}{% endif %}"
                class="logo">
                <img src="{{ url_for('static', filename='images/S4c.png') }}" alt="S4carlisle Logo" class="logo-image">
                <span>S4C Tools</span>
            </a>

            <nav class="nav-main">
                {# Admin sees everything #}
                {% if session.get('is_admin') %}
                <a href="{{ url_for('admin.admin_dashboard') }}"
                    class="nav-link {% if request.endpoint in ['admin_dashboard', 'admin_users', 'admin_files', 'admin_stats', 'admin_macro_history'] %}active{% endif %}">
                    <i class="fas fa-user-shield"></i> Admin Dashboard
                </a>

                <!-- show all tool links to admins -->
                <a href="{{ url_for('main.dashboard') }}"
                    class="nav-link {% if request.endpoint == 'dashboard' %}active{% endif %}">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>

                <a href="{{ url_for('ppd.ppd_route') }}"
                    class="nav-link {% if request.endpoint == 'ppd' %}active{% endif %}">
                    <i class="fas fa-magic"></i> Mss Reviews
                </a>

                <a href="{{ url_for('validation.validate_file') }}"
                    class="nav-link {% if request.endpoint == 'validate_file' %}active{% endif %}">
                    <i class="fas fa-check-circle"></i> Reference Validate
                </a>

                <a href="{{ url_for('macros.macro_processing') }}"
                    class="nav-link {% if request.endpoint == 'macro_processing' %}active{% endif %}">
                    <i class="fas fa-cogs"></i> Pre-editing
                </a>

                <a href="{{ url_for('macros.technical') }}"
                    class="nav-link {% if request.endpoint == 'technical' %}active{% endif %}">
                    <i class="fas fa-tools"></i> Technical Editing
                </a>

                <a href="{{ url_for('macros.language') }}"
                    class="nav-link {% if request.endpoint == 'language' %}active{% endif %}">
                    <i class="fas fa-language"></i> Language Editing
                </a>

                <a href="{{ url_for('main.file_history') }}"
                    class="nav-link {% if request.endpoint == 'file_history' %}active{% endif %}">
                    <i class="fas fa-history"></i> History
                </a>

                <a href="{{ url_for('doi.doi_finder') }}"
                    class="nav-link {% if request.endpoint == 'doi_finder' %}active{% endif %}">
                    <i class="fas fa-search"></i> DOI Validation
                </a>

                <!-- Admin user management shortcuts -->
                <a href="{{ url_for('admin.admin_users') }}"
                    class="nav-link {% if request.endpoint == 'admin_users' %}active{% endif %}">
                    <i class="fas fa-users-cog"></i> Manage Users
                </a>

                <a href="{{ url_for('admin.admin_create_user') }}"
                    class="nav-link {% if request.endpoint == 'admin_create_user' %}active{% endif %}">
                    <i class="fas fa-user-plus"></i> Create User
                </a>

                {% elif 'user_id' in session %}
                {# Non-admin users: show role-filtered links #}

                <a href="{{ url_for('main.dashboard') }}"
                    class="nav-link {% if request.endpoint == 'dashboard' %}active{% endif %}">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>

                <!-- PPD (roles: PPD, PM, ADMIN) -->
                {% if current_role in ['PPD','PM','ADMIN'] %}
                <a href="{{ url_for('ppd.ppd_route') }}"
                    class="nav-link {% if request.endpoint == 'ppd' %}active{% endif %}">
                    <i class="fas fa-magic"></i> Mss Reviews
                </a>
                {% endif %}
                {% if current_role in ['COPYEDIT','ADMIN'] %}
                <!-- Validation is available to all logged-in users -->
                <a href="{{ url_for('validation.validate_file') }}"
                    class="nav-link {% if request.endpoint == 'validate_file' %}active{% endif %}">
                    <i class="fas fa-check-circle"></i> Reference Validate
                </a>
                {% endif %}
                <!-- Pre-editing (roles: COPYEDIT, PPD, PM, ADMIN) -->
                {% if current_role in ['COPYEDIT','ADMIN'] %}
                <a href="{{ url_for('macros.macro_processing') }}"
                    class="nav-link {% if request.endpoint == 'macro_processing' %}active{% endif %}">
                    <i class="fas fa-cogs"></i> Pre-editing
                </a>
                {% endif %}

                <!-- Technical Editing (roles: COPYEDIT, PM, ADMIN) -->
                {% if current_role in ['COPYEDIT','ADMIN'] %}
                <a href="{{ url_for('macros.technical') }}"
                    class="nav-link {% if request.endpoint == 'technical' %}active{% endif %}">
                    <i class="fas fa-tools"></i> Technical Editing
                </a>
                {% endif %}

                <!-- Language Editing (roles: COPYEDIT, PM, ADMIN) -->
                {% if current_role in ['COPYEDIT', 'ADMIN'] %}
                <a href="{{ url_for('macros.language') }}"
                    class="nav-link {% if request.endpoint == 'language' %}active{% endif %}">
                    <i class="fas fa-language"></i> Language Editing
                </a>
                {% endif %}

                <a href="{{ url_for('main.file_history') }}"
                    class="nav-link {% if request.endpoint == 'file_history' %}active{% endif %}">
                    <i class="fas fa-history"></i> History
                </a>
                {% if current_role in ['COPYEDIT', 'ADMIN'] %}
                <a href="{{ url_for('doi.doi_finder') }}"
                    class="nav-link {% if request.endpoint == 'doi_finder' %}active{% endif %}">
                    <i class="fas fa-search"></i> DOI Validation
                </a>
                {% endif %}
                {% else %}
                <!-- Not logged in -->
                <a href="{{ url_for('auth.login') }}" class="nav-link">
                    <i class="fas fa-sign-in-alt"></i> Login
                </a>
                <a href="{{ url_for('auth.register') }}" class="nav-link">
                    <i class="fas fa-user-plus"></i> Register
                </a>
                {% endif %}

                {# user info + logout always at right end of menu when logged-in #}
                {% if 'user_id' in session %}
                <div class="user-info">
                    <i class="fas fa-user"></i>&nbsp;<strong>{{ session['username'] }}</strong>

                    {% if current_role and current_role != 'USER' %}
                    <span class="role-badge">{{ current_role }}</span>
                    {% endif %}

                    {% if session.get('is_admin') %}
                    <span class="admin-badge">Admin</span>
                    {% endif %}

                    <a href="{{ url_for('auth.logout') }}" class="nav-link" style="margin-left:10px;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
                {% endif %}
            </nav>
        </div>
    </header>
    {% endif %}

    <main class="main-content container">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-messages">
            {% for category, message in messages %}
            <div class="flash {{ category }}">
                <span>{{ message }}</span>
                <button class="close" onclick="this.parentElement.style.display='none'">&times;</button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>

    <footer class="app-footer">
        <div class="footer-content">
            <p>&copy; 2024 S4Carlisle Publishing Services. All rights reserved.</p>
        </div>
    </footer>

    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    <script>
        // Create bubbles dynamically
        document.addEventListener('DOMContentLoaded', function () {
            const bubblesContainer = document.querySelector('.bubbles');
            const bubbleCount = 15;

            for (let i = 0; i < bubbleCount; i++) {
                const bubble = document.createElement('div');
                bubble.classList.add('bubble');

                const size = Math.random() * 100 + 50;
                const posX = Math.random() * 100;
                const delay = Math.random() * 15;
                const duration = 10 + Math.random() * 20;

                bubble.style.width = `${size}px`;
                bubble.style.height = `${size}px`;
                bubble.style.left = `${posX}%`;
                bubble.style.animationDelay = `${delay}s`;
                bubble.style.animationDuration = `${duration}s`;

                bubblesContainer.appendChild(bubble);
            }
        });
    </script>
    {% block extra_js %}{% endblock %}
</body>

</html>