{% extends "base.html" %}

{% block title %}Bulk DOI Finder - S4carlisle{% endblock %}

{% block extra_css %}
<style>
    .drop-zone {
        border: 3px dashed var(--primary);
        border-radius: var(--border-radius);
        padding: 2rem;
        text-align: center;
        margin: 1.5rem 0;
        transition: var(--transition);
        background: rgba(67, 97, 238, 0.05);
        cursor: pointer;
    }
    .drop-zone:hover {
        background: rgba(67, 97, 238, 0.1);
        border-color: var(--primary-dark);
    }
    .drop-zone.highlight {
        background: rgba(67, 97, 238, 0.15);
        border-color: var(--secondary);
        transform: scale(1.02);
    }
    .file-list {
        margin-top: 1.5rem;
        max-height: 300px;
        overflow-y: auto;
    }
    .file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: var(--gray-100);
        border-radius: var(--border-radius-sm);
        margin-bottom: 0.5rem;
    }
    .file-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    .file-icon {
        color: var(--primary);
        font-size: 1.2rem;
    }
    .remove-file {
        color: var(--danger);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 50%;
        transition: var(--transition);
    }
    .remove-file:hover {
        background: rgba(239, 71, 111, 0.1);
    }
    .search-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: var(--gray-100);
        border-radius: var(--border-radius);
    }
    .search-input {
        width: 100%;
        padding: 1rem;
        border: 2px solid var(--gray-300);
        border-radius: var(--border-radius);
        margin-bottom: 1rem;
        transition: var(--transition);
    }
    .search-input:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }
    .search-button {
        width: 100%;
        padding: 1rem;
    }
    .results-container {
        margin-top: 2rem;
    }
    .result-card {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-sm);
        border-left: 4px solid var(--primary);
    }
    .citation {
        background: var(--gray-100);
        padding: 1rem;
        border-radius: var(--border-radius-sm);
        margin: 1rem 0;
        font-family: monospace;
        white-space: pre-wrap;
    }
    .metadata-table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
    }
    .metadata-table th, .metadata-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid var(--gray-300);
    }
    .metadata-table th {
        background: var(--gray-200);
        font-weight: 600;
    }
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(67, 97, 238, 0.3);
        border-radius: 50%;
        border-top-color: var(--primary);
        animation: spin 1s ease-in-out infinite;
        margin-left: 10px;
        vertical-align: middle;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .error-message {
        background: rgba(239, 71, 111, 0.1);
        color: var(--danger);
        padding: 1rem;
        border-radius: var(--border-radius-sm);
        border-left: 4px solid var(--danger);
        margin: 1rem 0;
    }
    .success-message {
        background: rgba(6, 214, 160, 0.1);
        color: var(--success);
        padding: 1rem;
        border-radius: var(--border-radius-sm);
        border-left: 4px solid var(--success);
        margin: 1rem 0;
    }
    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 1.5rem 0 1rem 0;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--primary-light);
    }
    .progress-container {
        height: 10px;
        background-color: var(--gray-300);
        border-radius: 5px;
        margin: 1rem 0;
        overflow: hidden;
    }
    .progress-bar {
        height: 100%;
        background-color: var(--primary);
        border-radius: 5px;
        width: 0%;
        transition: width 0.3s ease;
    }
    .reference-item {
        padding: 1rem;
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius-sm);
        margin-bottom: 1rem;
        background: white;
    }
    .reference-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }
    .status-icon {
        font-size: 1.2rem;
    }
    .status-pending {
        color: var(--warning);
    }
    .status-success {
        color: var(--success);
    }
    .status-error {
        color: var(--danger);
    }
    .export-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="content-card fade-in">
    <div class="text-center mb-3">
        <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
            Bulk DOI Finder
        </h1>
        <p class="text-muted">Upload and validate multiple references, receive APA and AMA formatted citations</p>
    </div>

    <div class="search-section">
        <h3 class="mb-2">Upload References</h3>
        <p class="text-muted">Upload a text file with one reference per line, or paste references directly</p>
        
        <div class="drop-zone" id="refDropZone">
            <i class="fas fa-cloud-upload-alt" style="font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem;"></i>
            <p>Drag & drop your reference file here or click to browse</p>
            <p class="text-muted">Supports .txt files with one reference per line</p>
            <input type="file" id="refFile" name="ref_file" accept=".txt" style="display: none;">
        </div>
        
        <div class="form-group">
            <label class="form-label">Or paste references directly (one per line)</label>
            <textarea id="refTextArea" class="search-input" placeholder="Paste references here, one per line..." rows="5"></textarea>
        </div>
        
        <div class="file-list" id="refFileList"></div>
        
        <button onclick="processReferences()" class="btn btn-primary search-button">
            <i class="fas fa-play"></i> Process References
        </button>
    </div>

    <div class="search-section">
        <h3 class="mb-2">Individual DOI or URL Lookup</h3>
        <input id="inputField" type="text" class="search-input" placeholder="Enter DOI or URL here..." />
        <button onclick="fetchMetadata()" class="btn btn-primary search-button">
            <i class="fas fa-search"></i> Get Metadata
        </button>
        <div id="output"></div>
    </div>

    <div class="search-section">
        <h3 class="mb-2">Individual Title Search</h3>
        <textarea id="titleInput" class="search-input" placeholder="Paste article title, journal title, book, proceeding, or chapter title here..." rows="3"></textarea>
        <button onclick="searchPubMedCrossRef()" class="btn btn-primary search-button">
            <i class="fas fa-search"></i> Search DOI & Metadata
        </button>
        <div id="result2"></div>
    </div>

    <div id="bulkResults" class="results-container" style="display: none;">
        <div class="section-title">Bulk Processing Results</div>
        <div class="progress-container">
            <div id="progressBar" class="progress-bar"></div>
        </div>
        <div id="progressText" class="text-center text-muted">Processing 0 of 0 references</div>
        <div id="referencesList"></div>
        
        <div class="export-buttons">
            <button onclick="exportResults('apa')" class="btn btn-success">
                <i class="fas fa-download"></i> Export APA Citations
            </button>
            <button onclick="exportResults('ama')" class="btn btn-success">
                <i class="fas fa-download"></i> Export AMA Citations
            </button>
            <button onclick="exportResults('all')" class="btn btn-primary">
                <i class="fas fa-download"></i> Export All Data
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Reference processing variables
    let references = [];
    let processingResults = [];
    let currentProcessingIndex = 0;
    
    // DOM elements
    const refDropZone = document.getElementById('refDropZone');
    const refFileInput = document.getElementById('refFile');
    const refTextArea = document.getElementById('refTextArea');
    const refFileList = document.getElementById('refFileList');
    const bulkResults = document.getElementById('bulkResults');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const referencesList = document.getElementById('referencesList');
    
    // Set up drop zone
    refDropZone.addEventListener('click', () => refFileInput.click());
    
    refDropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        refDropZone.classList.add('highlight');
    });
    
    ['dragleave', 'dragend'].forEach(type => {
        refDropZone.addEventListener(type, () => {
            refDropZone.classList.remove('highlight');
        });
    });
    
    refDropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        refDropZone.classList.remove('highlight');
        handleRefFile(e.dataTransfer.files[0]);
    });
    
    refFileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleRefFile(e.target.files[0]);
        }
    });
    
    function handleRefFile(file) {
        if (file && file.name.toLowerCase().endsWith('.txt')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                refTextArea.value = e.target.result;
                updateFileList(file);
            };
            reader.readAsText(file);
        } else {
            showAlert('Only .txt files are supported', 'error');
        }
    }
    
    function updateFileList(file) {
        refFileList.innerHTML = '';
        if (file) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <div class="file-info">
                    <i class="fas fa-file-alt file-icon"></i>
                    <div>
                        <div>${file.name}</div>
                        <div class="text-muted">${formatFileSize(file.size)}</div>
                    </div>
                </div>
                <i class="fas fa-times remove-file" onclick="clearFile()"></i>
            `;
            refFileList.appendChild(fileItem);
        }
    }
    
    function clearFile() {
        refFileInput.value = '';
        refFileList.innerHTML = '';
        refTextArea.value = '';
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function processReferences() {
        const refText = refTextArea.value.trim();
        if (!refText) {
            showAlert('Please upload a file or paste references', 'error');
            return;
        }
        
        // Split references by new lines and filter out empty lines
        references = refText.split('\n')
            .map(ref => ref.trim())
            .filter(ref => ref.length > 0);
        
        if (references.length === 0) {
            showAlert('No valid references found', 'error');
            return;
        }
        
        // Reset processing state
        processingResults = [];
        currentProcessingIndex = 0;
        
        // Show results container
        bulkResults.style.display = 'block';
        referencesList.innerHTML = '';
        
        // Start processing
        processNextReference();
    }
    
    function processNextReference() {
        if (currentProcessingIndex >= references.length) {
            // Processing complete
            progressBar.style.width = '100%';
            progressText.textContent = `Processing complete! Processed ${references.length} references`;
            return;
        }
        
        // Update progress
        const progress = ((currentProcessingIndex + 1) / references.length) * 100;
        progressBar.style.width = `${progress}%`;
        progressText.textContent = `Processing ${currentProcessingIndex + 1} of ${references.length} references`;
        
        const reference = references[currentProcessingIndex];
        
        // Create reference item in UI
        const refItem = document.createElement('div');
        refItem.className = 'reference-item';
        refItem.id = `ref-${currentProcessingIndex}`;
        refItem.innerHTML = `
            <div class="reference-status">
                <i class="fas fa-circle-notch fa-spin status-icon status-pending"></i>
                <span>Processing: "${reference}"</span>
            </div>
            <div class="result-content"></div>
        `;
        referencesList.appendChild(refItem);
        
        // Try to process this reference
        processReference(reference, currentProcessingIndex)
            .then(result => {
                // Update UI with result
                const resultContent = document.getElementById(`ref-${currentProcessingIndex}`).querySelector('.result-content');
                const statusIcon = document.getElementById(`ref-${currentProcessingIndex}`).querySelector('.status-icon');
                
                statusIcon.className = 'fas fa-check-circle status-icon status-success';
                
                if (result.success) {
                    resultContent.innerHTML = `
                        <div><strong>DOI:</strong> <a href="https://doi.org/${result.doi}" target="_blank">${result.doi}</a></div>
                        <div><strong>APA Format:</strong><div class="citation">${result.apa}</div></div>
                        <div><strong>AMA Format:</strong><div class="citation">${result.ama}</div></div>
                    `;
                } else {
                    resultContent.innerHTML = `
                        <div class="error-message">${result.error}</div>
                    `;
                }
                
                // Store result and process next reference
                processingResults.push(result);
                currentProcessingIndex++;
                processNextReference();
            })
            .catch(error => {
                // Handle error
                const resultContent = document.getElementById(`ref-${currentProcessingIndex}`).querySelector('.result-content');
                const statusIcon = document.getElementById(`ref-${currentProcessingIndex}`).querySelector('.status-icon');
                
                statusIcon.className = 'fas fa-exclamation-circle status-icon status-error';
                resultContent.innerHTML = `<div class="error-message">Error processing reference: ${error.message}</div>`;
                
                processingResults.push({
                    success: false,
                    error: `Error: ${error.message}`,
                    reference: reference
                });
                
                currentProcessingIndex++;
                processNextReference();
            });
    }
    
    async function processReference(reference, index) {
        // First try to extract DOI from the reference text
        const doiRegex = /10.\d{4,9}\/[-._;()/:A-Z0-9]+/i;
        const doiMatch = reference.match(doiRegex);
        
        if (doiMatch) {
            // If we found a DOI, try to fetch metadata
            try {
                const doi = doiMatch[0];
                const response = await fetch(`https://api.crossref.org/works/${encodeURIComponent(doi)}`);
                
                if (!response.ok) {
                    throw new Error(`DOI not found: ${doi}`);
                }
                
                const data = await response.json();
                const message = data.message;
                
                return {
                    success: true,
                    reference: reference,
                    doi: doi,
                    apa: generateAPACitation(message),
                    ama: generateAMACitation(message),
                    data: message
                };
            } catch (error) {
                // If DOI lookup fails, try title search
                return await searchByTitle(reference);
            }
        } else {
            // No DOI found, try title search
            return await searchByTitle(reference);
        }
    }
    
    async function searchByTitle(title) {
        try {
            const crossrefUrl = 'https://api.crossref.org/works?query.title=' + encodeURIComponent(title) + '&rows=1';
            const crossRefRes = await fetch(crossrefUrl);
            const crossRefData = await crossRefRes.json();
            
            if (!crossRefData.message.items || crossRefData.message.items.length === 0) {
                throw new Error('No results found for this title');
            }
            
            const item = crossRefData.message.items[0];
            const doi = item.DOI || 'No DOI found';
            
            return {
                success: true,
                reference: title,
                doi: doi,
                apa: generateAPACitation(item),
                ama: generateAMACitation(item),
                data: item
            };
        } catch (error) {
            return {
                success: false,
                reference: title,
                error: `Could not find metadata for reference: ${error.message}`
            };
        }
    }
    
    function exportResults(format) {
        if (processingResults.length === 0) {
            showAlert('No results to export', 'error');
            return;
        }
        
        let content = '';
        let filename = '';
        
        if (format === 'apa') {
            filename = 'apa_citations.txt';
            processingResults.forEach(result => {
                if (result.success) {
                    content += result.apa + '\n\n';
                }
            });
        } else if (format === 'ama') {
            filename = 'ama_citations.txt';
            processingResults.forEach(result => {
                if (result.success) {
                    content += result.ama + '\n\n';
                }
            });
        } else {
            filename = 'all_reference_data.txt';
            processingResults.forEach(result => {
                content += `Reference: ${result.reference}\n`;
                if (result.success) {
                    content += `DOI: ${result.doi}\n`;
                    content += `APA: ${result.apa}\n`;
                    content += `AMA: ${result.ama}\n`;
                } else {
                    content += `Status: Error - ${result.error}\n`;
                }
                content += '\n';
            });
        }
        
        // Create download link
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    // The rest of the DOI processing functions (isValidDOI, extractDOIFromURL, isValidURL, 
    // journalAbbreviations, abbreviateJournalName, formatAuthorsAPA, formatAuthorsAMA,
    // generateAPACitation, generateAMACitation, fetchMetadata, searchPubMedCrossRef, 
    // formatDateParts, and event listeners) would be included here
    // [Previous DOI processing code would be inserted at this point]
    
    function showAlert(message, type) {
        // Alert function implementation from previous code
        const alertDiv = document.createElement('div');
        alertDiv.className = `flash ${type}`;
        alertDiv.innerHTML = `
            ${message}
            <button class="close">&times;</button>
        `;
        const flashContainer = document.querySelector('.flash-messages') || document.createElement('div');
        if (!document.querySelector('.flash-messages')) {
            flashContainer.className = 'flash-messages';
            document.querySelector('.main-content').prepend(flashContainer);
        }
        flashContainer.appendChild(alertDiv);
        alertDiv.querySelector('.close').addEventListener('click', () => {
            alertDiv.remove();
        });
        setTimeout(() => alertDiv.remove(), 5000);
    }
</script>

<!-- Insert the rest of the DOI processing JavaScript code here -->

<script>
    // [The complete DOI processing code from the previous implementation would be placed here]
    // This includes all the functions: isValidDOI, extractDOIFromURL, isValidURL,
    // journalAbbreviations, abbreviateJournalName, formatAuthorsAPA, formatAuthorsAMA,
    // generateAPACitation, generateAMACitation, fetchMetadata, searchPubMedCrossRef,
    // formatDateParts, and event listeners for Enter key
	    const doiRegex = /^10.\d{4,9}\/[-._;()/:A-Z0-9]+$/i;
    const doiInUrlRegex = /10.\d{4,9}\/[-._;()/:A-Z0-9]+/i;

    function isValidDOI(doi) {
        return doiRegex.test(doi);
    }

    function extractDOIFromURL(url) {
        const match = url.match(doiInUrlRegex);
        return match ? match[0] : null;
    }

    function isValidURL(str) {
        try {
            new URL(str);
            return true;
        } catch {
            return false;
        }
    }

    // Common journal abbreviations for AMA format
    const journalAbbreviations = {
        'New England Journal of Medicine': 'N Engl J Med',
        'The New England Journal of Medicine': 'N Engl J Med',
        'Journal of the American Medical Association': 'JAMA',
        'JAMA': 'JAMA',
        'The Lancet': 'Lancet',
        'British Medical Journal': 'BMJ',
        'Annals of Internal Medicine': 'Ann Intern Med',
        'Journal of Clinical Investigation': 'J Clin Invest',
        'Nature': 'Nature',
        'Science': 'Science',
        'Cell': 'Cell',
        'Proceedings of the National Academy of Sciences': 'Proc Natl Acad Sci U S A',
        'PNAS': 'Proc Natl Acad Sci U S A',
        'Journal of Immunology': 'J Immunol',
        'Blood': 'Blood',
        'Circulation': 'Circulation',
        'Journal of the American College of Cardiology': 'J Am Coll Cardiol',
        'Journal of the American Society of Nephrology': 'J Am Soc Nephrol',
        'Journal of the American Society of Nephrology': 'J Am Soc Nephrol',
        'JASN': 'J Am Soc Nephrol',
        'Frontiers in Neurology': 'Front Neurol',
        'Frontiers in Immunology': 'Front Immunol',
        'Neurology': 'Neurology',
        'Annals of Neurology': 'Ann Neurol',
        'JAMA Neurology': 'JAMA Neurol',
        'JAMA Psychiatry': 'JAMA Psychiatry',
        'JAMA Internal Medicine': 'JAMA Intern Med',
        'JAMA Surgery': 'JAMA Surg',
        'JAMA Pediatrics': 'JAMA Pediatr',
        'JAMA Ophthalmology': 'JAMA Ophthalmol',
        'JAMA Otolaryngology‚ÄìHead & Neck Surgery': 'JAMA Otolaryngol Head Neck Surg',
        'JAMA Dermatology': 'JAMA Dermatol',
        'JAMA Cardiology': 'JAMA Cardiol',
        'JAMA Oncology': 'JAMA Oncol',
        'Journal of Neuroscience': 'J Neurosci',
        'Journal of Neuroinflammation': 'J Neuroinflammation',
        'Brain': 'Brain',
        'Brain Research': 'Brain Res',
        'Neuroscience': 'Neuroscience',
        'Nature Neuroscience': 'Nat Neurosci',
        'Nature Medicine': 'Nat Med',
        'Nature Reviews Neuroscience': 'Nat Rev Neurosci',
        'Science Translational Medicine': 'Sci Transl Med',
        'Journal of Clinical Oncology': 'J Clin Oncol',
        'Journal of the National Cancer Institute': 'J Natl Cancer Inst',
        'Cancer Research': 'Cancer Res',
        'Clinical Cancer Research': 'Clin Cancer Res',
        'American Journal of Respiratory and Critical Care Medicine': 'Am J Respir Crit Care Med',
        'Chest': 'Chest',
        'Thorax': 'Thorax',
        'European Respiratory Journal': 'Eur Respir J',
        'Diabetes': 'Diabetes',
        'Diabetes Care': 'Diabetes Care',
        'Diabetologia': 'Diabetologia',
        'Journal of Clinical Endocrinology & Metabolism': 'J Clin Endocrinol Metab',
        'Endocrinology': 'Endocrinology',
        'Hepatology': 'Hepatology',
        'Journal of Hepatology': 'J Hepatol',
        'Gastroenterology': 'Gastroenterology',
        'Gut': 'Gut',
        'American Journal of Gastroenterology': 'Am J Gastroenterol',
        'Rheumatology': 'Rheumatology',
        'Annals of the Rheumatic Diseases': 'Ann Rheum Dis',
        'Arthritis & Rheumatology': 'Arthritis Rheumatol',
        'Kidney International': 'Kidney Int',
        'American Journal of Kidney Diseases': 'Am J Kidney Dis',
        'Clinical Journal of the American Society of Nephrology': 'Clin J Am Soc Nephrol',
        'Nephrology Dialysis Transplantation': 'Nephrol Dial Transplant',
        'Journal of the American Geriatrics Society': 'J Am Geriatr Soc',
        'Journal of Gerontology': 'J Gerontol',
        'Aging Cell': 'Aging Cell',
        'PLOS ONE': 'PLoS One',
        'PLOS Medicine': 'PLoS Med',
        'PLOS Biology': 'PLoS Biol',
        'BMC Medicine': 'BMC Med',
        'BMC Biology': 'BMC Biol',
        'Molecular Psychiatry': 'Mol Psychiatry',
        'Biological Psychiatry': 'Biol Psychiatry',
        'American Journal of Psychiatry': 'Am J Psychiatry',
        'Journal of Affective Disorders': 'J Affect Disord',
        'Schizophrenia Research': 'Schizophr Res',
        'Journal of Infectious Diseases': 'J Infect Dis',
        'Clinical Infectious Diseases': 'Clin Infect Dis',
        'The Journal of Infectious Diseases': 'J Infect Dis',
        'Emerging Infectious Diseases': 'Emerg Infect Dis',
        'Infection and Immunity': 'Infect Immun',
        'Vaccine': 'Vaccine',
        'Journal of Virology': 'J Virol',
        'Antimicrobial Agents and Chemotherapy': 'Antimicrob Agents Chemother',
        'Journal of Antimicrobial Chemotherapy': 'J Antimicrob Chemother',
        'Clinical Microbiology Reviews': 'Clin Microbiol Rev',
        'Journal of Clinical Microbiology': 'J Clin Microbiol'
    };

    function abbreviateJournalName(journalName) {
        if (!journalName) return 'No journal available';

        // Check if we have a direct abbreviation
        if (journalAbbreviations[journalName]) {
            return journalAbbreviations[journalName];
        }

        // Try to find a partial match
        for (const [fullName, abbreviation] of Object.entries(journalAbbreviations)) {
            if (journalName.includes(fullName) || fullName.includes(journalName)) {
                return abbreviation;
            }
        }

        // Default abbreviation rules for common patterns
        const abbreviationRules = [
            { pattern: /Journal of (\w+)/gi, replacement: 'J $1' },
            { pattern: /American Journal of (\w+)/gi, replacement: 'Am J $1' },
            { pattern: /British Journal of (\w+)/gi, replacement: 'Br J $1' },
            { pattern: /European Journal of (\w+)/gi, replacement: 'Eur J $1' },
            { pattern: /Annals of (\w+)/gi, replacement: 'Ann $1' },
            { pattern: /Archives of (\w+)/gi, replacement: 'Arch $1' },
            { pattern: /Clinical (\w+)/gi, replacement: 'Clin $1' },
            { pattern: /International Journal of (\w+)/gi, replacement: 'Int J $1' },
            { pattern: /\bof\b/gi, replacement: '' },
            { pattern: /\bthe\b/gi, replacement: '' },
            { pattern: /\band\b/gi, replacement: '&' },
            { pattern: /\s+/g, replacement: ' ' },
            { pattern: /^ +| +$|( ) +/g, replacement: '$1' }
        ];

        let abbreviated = journalName;
        for (const rule of abbreviationRules) {
            abbreviated = abbreviated.replace(rule.pattern, rule.replacement);
        }

        // Capitalize first letters and remove extra spaces
        abbreviated = abbreviated.trim()
            .split(' ')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
            .join(' ');

        return abbreviated;
    }

    // Format authors for citations
    function formatAuthorsAPA(authors) {
        if (!authors || authors.length === 0) return '';

        if (authors.length === 1) {
            return `${authors[0].family}, ${authors[0].given?.charAt(0) || ''}.`;
        } else if (authors.length === 2) {
            return `${authors[0].family}, ${authors[0].given?.charAt(0) || ''}., & ${authors[1].family}, ${authors[1].given?.charAt(0) || ''}.`;
        } else {
            return authors.map((author, index) => {
                if (index === authors.length - 1) {
                    return `& ${author.family}, ${author.given?.charAt(0) || ''}.`;
                }
                return `${author.family}, ${author.given?.charAt(0) || ''}.`;
            }).join(', ');
        }
    }

    function formatAuthorsAMA(authors) {
        if (!authors || authors.length === 0) return '';

        if (authors.length <= 6) {
            return authors.map(author => `${author.family} ${author.given?.charAt(0) || ''}`).join(', ');
        } else {
            const firstThree = authors.slice(0, 3).map(author => `${author.family} ${author.given?.charAt(0) || ''}`);
            return `${firstThree.join(', ')}, et al.`;
        }
    }

    // Generate APA citation
    function generateAPACitation(data) {
        const authors = data.author ? formatAuthorsAPA(data.author) : 'Unknown authors';
        const year = data.created?.['date-parts']?.[0]?.[0] || data.year || new Date().getFullYear();
        const title = data.title?.[0] || data.title || 'No title available';
        const journal = data['container-title']?.[0] || data.journal || 'No journal available';
        const volume = data.volume || '';
        const issue = data.issue ? `(${data.issue})` : '';
        const pages = data.page ? `, ${data.page}` : '';
        const doi = data.DOI ? ` https://doi.org/${data.DOI}` : '';

        return `${authors} (${year}). ${title}. ${journal}, ${volume}${issue}${pages}.${doi}`;
    }

    // Generate AMA citation with proper journal abbreviations
    function generateAMACitation(data) {
        const authors = data.author ? formatAuthorsAMA(data.author) : 'Unknown authors';
        const year = data.created?.['date-parts']?.[0]?.[0] || data.year || new Date().getFullYear();
        const title = data.title?.[0] || data.title || 'No title available';
        const fullJournal = data['container-title']?.[0] || data.journal || 'No journal available';
        const journal = abbreviateJournalName(fullJournal);
        const volume = data.volume || '';
        const issue = data.issue ? `(${data.issue})` : '';
        const pages = data.page ? `:${data.page}` : '';
        const doi = data.DOI ? `. doi:${data.DOI}` : '';

        return `${authors}. ${title}. ${journal}. ${year};${volume}${issue}${pages}${doi}`;
    }

    // Fetch metadata for a DOI or URL
    async function fetchMetadata() {
        const input = document.getElementById('inputField').value.trim();
        const outputDiv = document.getElementById('output');
        outputDiv.innerHTML = '<div class="text-center">‚è≥ Processing... <span class="loading"></span></div>';

        if (!input) {
            outputDiv.innerHTML = '<div class="error-message">‚ö†Ô∏è Please enter a DOI or URL.</div>';
            return;
        }

        let doi = input;

        // Check if input is a URL containing a DOI
        if (isValidURL(input)) {
            const extractedDOI = extractDOIFromURL(input);
            if (extractedDOI) {
                doi = extractedDOI;
                outputDiv.innerHTML += `<div>Extracted DOI from URL: ${doi}</div>`;
            } else {
                outputDiv.innerHTML = '<div class="error-message">‚ùå No DOI found in the provided URL.</div>';
                return;
            }
        } else if (!isValidDOI(input)) {
            outputDiv.innerHTML = '<div class="error-message">‚ùå Invalid DOI format.</div>';
            return;
        }

        try {
            // First try to fetch from CrossRef
            outputDiv.innerHTML = '<div class="text-center">üîç Searching CrossRef... <span class="loading"></span></div>';

            const response = await fetch(`https://api.crossref.org/works/${encodeURIComponent(doi)}`);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            const message = data.message;

            // Format the response with citations
            let html = `<div class="success-message">‚úÖ Metadata found for DOI: ${doi}</div>`;
            html += `<div class="result-card">`;
            html += `<div class="section-title">Document Details</div>`;

            html += `<table class="metadata-table">`;
            html += `<tr><th>Title</th><td>${message.title ? message.title[0] : 'Not available'}</td></tr>`;

            if (message.author && message.author.length > 0) {
                html += `<tr><th>Authors</th><td>${message.author.map(a => `${a.given} ${a.family}`).join(', ')}</td></tr>`;
            }

            html += `<tr><th>Publisher</th><td>${message.publisher || 'Not available'}</td></tr>`;

            if (message['published-online']) {
                const dateParts = message['published-online']['date-parts'][0];
                html += `<tr><th>Published Online</th><td>${dateParts.join('-')}</td></tr>`;
            } else if (message['published-print']) {
                const dateParts = message['published-print']['date-parts'][0];
                html += `<tr><th>Published Print</th><td>${dateParts.join('-')}</td></tr>`;
            }

            if (message.URL) {
                html += `<tr><th>URL</th><td><a href="${message.URL}" target="_blank">${message.URL}</a></td></tr>`;
            }
            html += `</table>`;

            // Add citation formats
            html += `<div class="section-title">Citation Formats</div>`;
            html += `<div><strong>APA Format:</strong><div class="citation">${generateAPACitation(message)}</div></div>`;
            html += `<div><strong>AMA Format:</strong><div class="citation">${generateAMACitation(message)}</div></div>`;

            html += `</div>`;

            outputDiv.innerHTML = html;

        } catch (error) {
            outputDiv.innerHTML = `<div class="error-message">‚ùå Error fetching metadata: ${error.message}</div>`;
        }
    }

    // Search PubMed first, then CrossRef
    async function searchPubMedCrossRef() {
        const title = document.getElementById('titleInput').value.trim();
        const result2Div = document.getElementById('result2');
        result2Div.innerHTML = '<div class="text-center">‚è≥ Searching... <span class="loading"></span></div>';

        if (!title) {
            result2Div.innerHTML = '<div class="error-message">‚ö†Ô∏è Please enter a title.</div>';
            return;
        }

        try {
            // --- CrossRef search ---
            const crossrefUrl = 'https://api.crossref.org/works?query.title=' + encodeURIComponent(title) + '&rows=1';
            const crossRefRes = await fetch(crossrefUrl);
            const crossRefData = await crossRefRes.json();

            if (!crossRefData.message.items || crossRefData.message.items.length === 0) {
                result2Div.innerHTML = '<div class="error-message">‚ùå No results found for this title.</div>';
                return;
            }

            const crossItem = crossRefData.message.items[0];
            const doi = crossItem.DOI || 'No DOI found';
            let epubDate = 'No Epub details found';

            if (crossItem['published-online']) {
                epubDate = formatDateParts(crossItem['published-online']['date-parts']);
            } else if (crossItem['published-print']) {
                epubDate = formatDateParts(crossItem['published-print']['date-parts']);
            }

            // --- Show CrossRef results ---
            let html = `
                <div class="success-message">‚úÖ Results Found</div>
                <div class="result-card">
                <div class="section-title">Document Info</div>
            `;

            html += `<table class="metadata-table">`;
            html += `<tr><th>DOI</th><td><a href="https://doi.org/${doi}" target="_blank">${doi}</a></td></tr>`;
            html += `<tr><th>Epub Details</th><td>${epubDate}</td></tr>`;
            html += `<tr><th>Title</th><td>${crossItem.title ? crossItem.title[0] : 'N/A'}</td></tr>`;
            html += `<tr><th>Publisher</th><td>${crossItem.publisher || 'N/A'}</td></tr>`;
            html += `</table>`;

            // Add citation formats
            html += `<div class="section-title">Citation Formats</div>`;
            html += `<div><strong>APA Format:</strong><div class="citation">${generateAPACitation(crossItem)}</div></div>`;
            html += `<div><strong>AMA Format:</strong><div class="citation">${generateAMACitation(crossItem)}</div></div>`;

            html += `</div>`;

            result2Div.innerHTML = html;

        } catch (error) {
            result2Div.innerHTML = '<div class="error-message">‚ùå Error fetching data: ' + error.message + '</div>';
        }
    }

    // --- Utility function for date formatting ---
    function formatDateParts(dateParts) {
        if (!dateParts || !dateParts[0]) return 'N/A';
        const parts = dateParts[0];
        return parts.join('-');
    }

    // Add event listeners for Enter key
    document.getElementById('inputField').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            fetchMetadata();
        }
    });

    document.getElementById('titleInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchPubMedCrossRef();
        }
    });
</script>
{% endblock %}