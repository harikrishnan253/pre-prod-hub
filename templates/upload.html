{% extends "base.html" %}

{% block title %}Upload Document{% endblock %}

{% block extra_css %}
<style>
    .upload-container {
        background: rgba(255, 255, 255, 0.9);
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.4);
        animation: fadeIn 0.6s ease-out forwards;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .upload-container h2 {
        color: var(--black);
        font-size: 32px;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 3px solid;
        border-image: linear-gradient(45deg, var(--rainbow-1), var(--rainbow-4)) 1;
    }

    .drop-zone {
        border: 3px dashed var(--primary);
        border-radius: 12px;
        padding: 3rem 2rem;
        text-align: center;
        margin: 2rem 0;
        transition: all 0.4s ease;
        background: rgba(67, 97, 238, 0.05);
        cursor: pointer;
    }

    .drop-zone.highlight {
        background: rgba(67, 97, 238, 0.15);
        border-color: var(--secondary);
    }

    .file-input {
        display: none;
    }

    .file-list {
        margin-top: 20px;
        max-height: 350px;
        overflow-y: auto;
    }

    .file-item {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        padding: 10px 15px;
        margin-bottom: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .file-name {
        font-weight: 600;
        color: var(--black);
    }

    .progress-bar-container {
        margin-top: 5px;
        background: #eee;
        border-radius: 5px;
        height: 8px;
        overflow: hidden;
    }

    .progress-bar {
        background: linear-gradient(45deg, var(--rainbow-1), var(--rainbow-4));
        width: 0%;
        height: 100%;
        transition: width 0.3s ease;
    }

    .file-status {
        font-size: 13px;
        margin-top: 5px;
        color: var(--black);
    }

    .btn-upload {
        padding: 14px 28px;
        background: linear-gradient(45deg, var(--rainbow-2), var(--rainbow-4));
        color: black;
        font-weight: bold;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-upload:hover {
        transform: translateY(-2px);
    }

    .btn-clear {
        background: rgba(239, 71, 111, 0.1);
        border: 1px solid var(--danger);
        color: var(--danger);
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
    }

    .btn-clear:hover {
        background: var(--danger);
        color: white;
    }

    .upload-success {
        background: rgba(6, 214, 160, 0.1);
        border-left: 5px solid var(--success);
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
    }

    .btn-download {
        background: linear-gradient(45deg, var(--rainbow-3), var(--rainbow-4));
        color: black;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="upload-container">
    <h2>Upload Documents for Validation</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="flash-messages">
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <div class="drop-zone" id="dropZone">
        <i class="fas fa-cloud-upload-alt" style="font-size:3rem;color:var(--primary);"></i>
        <h3>Drag & Drop or Browse Files</h3>
        <p>Supported formats: .doc, .docx</p>
        <button type="button" class="btn-upload" onclick="document.getElementById('fileInput').click()">Browse</button>
        <input type="file" id="fileInput" name="files" class="file-input" accept=".doc,.docx" multiple>
    </div>

    <div id="fileList" class="file-list"></div>

    <div style="margin-top:20px;text-align:center;">
        <button id="startUpload" class="btn-upload" style="display:none;">
            <i class="fas fa-paper-plane"></i> Start Validation
        </button>
        <button class="btn-clear" id="clearAll" style="display:none;">Clear All</button>
    </div>

    <div id="uploadSuccess" class="upload-success" style="display:none;">
        <h3>Validation Complete!</h3>
        <p>Your files have been validated successfully.</p>
        <div id="downloadLinks"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const dropZone = document.getElementById("dropZone");
        const fileInput = document.getElementById("fileInput");
        const fileList = document.getElementById("fileList");
        const startUpload = document.getElementById("startUpload");
        const clearAll = document.getElementById("clearAll");
        const uploadSuccess = document.getElementById("uploadSuccess");
        const downloadLinks = document.getElementById("downloadLinks");

        let selectedFiles = [];

        // === Drag and drop ===
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('highlight'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('highlight'), false);
        });

        dropZone.addEventListener('drop', e => handleFiles(e.dataTransfer.files));
        fileInput.addEventListener('change', () => handleFiles(fileInput.files));
        clearAll.addEventListener('click', () => resetFiles());
        startUpload.addEventListener('click', uploadFiles);

        function handleFiles(files) {
            for (let f of files) {
                const ext = f.name.split('.').pop().toLowerCase();
                if (['doc', 'docx'].includes(ext)) {
                    selectedFiles.push(f);
                }
            }
            renderFileList();
        }

        function renderFileList() {
            fileList.innerHTML = "";
            if (selectedFiles.length === 0) {
                startUpload.style.display = 'none';
                clearAll.style.display = 'none';
                return;
            }

            startUpload.style.display = 'inline-block';
            clearAll.style.display = 'inline-block';

            selectedFiles.forEach((file, idx) => {
                const item = document.createElement("div");
                item.className = "file-item";
                item.innerHTML = `
                <div class="file-name">${file.name}</div>
                <div class="progress-bar-container"><div class="progress-bar" id="progress-${idx}"></div></div>
                <div class="file-status" id="status-${idx}">Pending...</div>
            `;
                fileList.appendChild(item);
            });
        }

        function resetFiles() {
            selectedFiles = [];
            fileList.innerHTML = "";
            startUpload.style.display = 'none';
            clearAll.style.display = 'none';
            uploadSuccess.style.display = 'none';
        }

        function uploadFiles() {
            uploadSuccess.style.display = 'none';
            startUpload.disabled = true;
            downloadLinks.innerHTML = "";

            let completed = 0;
            let processedFiles = [];

            selectedFiles.forEach((file, index) => {
                const formData = new FormData();
                formData.append("files", file);
                // Include CSRF token both as form field and header to satisfy different CSRF checks
                const csrfToken = "{{ csrf_token() }}";
                formData.append("csrf_token", csrfToken);
                // Also set header (Flask-WTF will accept it when CSRFProtect checks headers)
                try {
                    xhr.setRequestHeader('X-CSRFToken', csrfToken);
                } catch (e) {
                    // some browsers disallow setting this header for FormData; ignore
                }

                const xhr = new XMLHttpRequest();
                xhr.open("POST", "{{ url_for('validation.validate_file') }}", true);
                xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

                xhr.upload.onprogress = function (e) {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        document.getElementById(`progress-${index}`).style.width = percent + '%';
                        document.getElementById(`status-${index}`).textContent = `Uploading... ${percent}%`;
                    }
                };

                xhr.onload = function () {
                    completed++;
                    if (xhr.status === 200) {
                        // Try to parse JSON; if parsing fails, the server may have returned HTML (e.g. redirect to login)
                        let data = null;
                        try {
                            data = JSON.parse(xhr.responseText);
                        } catch (err) {
                            console.error('Failed to parse JSON response:', err, xhr.responseText);
                            // Likely a redirect to login page or server-side error page
                            document.getElementById(`status-${index}`).textContent = "❌ Server returned non-JSON (possibly not logged in)";
                        }

                        if (data) {
                                if (data.success) {
                                    document.getElementById(`status-${index}`).textContent = "✅ Validated successfully";
                                    if (data.processed_files && data.processed_files.length > 0) {
                                        processedFiles.push(...data.processed_files);
                                    }
                                } else {
                                    // Show a specific error for this file if available
                                    let shown = false;
                                    if (data.errors && data.errors.length) {
                                        for (const err of data.errors) {
                                            // Expecting error strings like 'filename: message'
                                            if (err.startsWith(file.name + ':') || err.includes(file.name)) {
                                                document.getElementById(`status-${index}`).textContent = `❌ ${err.split(':').slice(1).join(':').trim()}`;
                                                shown = true;
                                                break;
                                            }
                                        }
                                        if (!shown) {
                                            // Show first error if no filename match
                                            document.getElementById(`status-${index}`).textContent = `❌ ${data.errors[0]}`;
                                        }
                                        console.warn('Validation errors:', data.errors);
                                    } else {
                                        document.getElementById(`status-${index}`).textContent = "❌ Validation failed";
                                    }
                                }
                        }
                    } else if (xhr.status === 302 || xhr.status === 301) {
                        // Redirects may have been followed; treat as auth problem
                        document.getElementById(`status-${index}`).textContent = "❌ Not authenticated (redirected to login)";
                    } else {
                        document.getElementById(`status-${index}`).textContent = "❌ Server error";
                        console.error('Upload failed', xhr.status, xhr.responseText);
                    }

                    if (completed === selectedFiles.length) {
                        startUpload.disabled = false;
                        showSuccess(processedFiles);
                    }
                };

                xhr.onerror = function () {
                    document.getElementById(`status-${index}`).textContent = "❌ Upload failed (network error)";
                    completed++;
                    if (completed === selectedFiles.length) showSuccess(processedFiles);
                };

                xhr.send(formData);
            });
        }

        function showSuccess(processedFiles) {
            uploadSuccess.style.display = 'block';
            downloadLinks.innerHTML = "";

            if (processedFiles.length > 0) {
                processedFiles.forEach(file => {
                    const link = document.createElement("a");
                    link.href = file.report_url;
                    link.className = "btn-download";
                    link.innerHTML = `<i class="fas fa-download"></i> ${file.filename}`;
                    link.target = "_blank";
                    downloadLinks.appendChild(link);
                });
            } else {
                const noFiles = document.createElement("p");
                noFiles.textContent = "No reports available.";
                downloadLinks.appendChild(noFiles);
            }
        }
    });
</script>
{% endblock %}